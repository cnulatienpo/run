<!--
  ============================================================
    INTEGRATION GAP (A1, A2) ‚Äì HUD ‚Üî RV-APP
  ------------------------------------------------------------
    ‚Ä¢ HUD does NOT embed <rv-app>.
    ‚Ä¢ HUD originally had NO link/button to open rv-app.
    ‚Ä¢ No <iframe>, no <rv-app> element.
    ‚Ä¢ Users could NOT reach rv-app unless typing the URL manually.
    ‚Ä¢ This was the root cause of the A1/A2 FAIL states.

    RESOLUTION:
    ‚Ä¢ Navigation must happen via an explicit button
      (e.g. ‚ÄúOpen Workahol Enabler‚Äù).
  ============================================================
-->

<!--
  NOTE (A9 FAIL):
    HUD does NOT call /api/clips or show clip library UI.
    Only rv-app has a Library page, and it displays local mnemonics only.
-->

<!-- NOTE: HUD never calls /api/clips. -->

<!--
  ------------------------------------------------------------
    WIRING ASSERTION A7 ‚Äì PASS
    (No CSP / No X-Frame-Options)
  ------------------------------------------------------------
    ‚Ä¢ This HTML file does NOT include:
        <meta http-equiv="Content-Security-Policy">
    ‚Ä¢ Servers do NOT send:
        X-Frame-Options: DENY
        X-Frame-Options: SAMEORIGIN

    Meaning:
      iframe embedding is NOT blocked.
      rv-app *could* be embedded if desired.
  ------------------------------------------------------------
-->

<!--
  ============================================================
    WIRING ASSERTIONS A1 + A2 ‚Äì DOCUMENTATION
  ------------------------------------------------------------
    A1 (HUD contains an <iframe>): FAIL
      - The HUD renders native video playback and metrics directly inside the page.
      - There is NO <iframe>.
      - Video is embedded via a <video> element inside #video-player.

    A2 (HUD links to rv-app): FAIL (original state)
      - HUD did NOT contain:
            ‚Ä¢ <rv-app>
            ‚Ä¢ a navigation link
            ‚Ä¢ an iframe pointing to /rv
      - rv-app was an isolated application until the
        ‚ÄúOpen Workahol Enabler‚Äù button was later added manually.

    Reason for Design:
      - HUD stays lightweight for overlays, step counters, playlists.
      - rv-app is a *separate full studio* and not mounted inside HUD.
      - Linking is intentional and happens externally, not via embedding.
  ============================================================
-->

<!--
  ============================================================
    HUD ROUTING & NAVIGATION ‚Äì PROJECT MAP
  ------------------------------------------------------------
    - This is the HUD homepage shown inside Electron.
    - Provides:
        * Google Auth
        * Video playlist controls
        * Step counter and telemetry
        * HUD visibility toggles
        * Passport export

    - IMPORTANT:
        * This page DOES NOT embed <rv-app>.
        * rv-app is a separate application served at /rv.
        * Navigation is intentionally done via a button:
              ‚ÄúOpen Workahol Enabler‚Äù
        * rv-app lives in rv-app/public/index.html and mounts <rv-app>.

    - Reason:
        * To keep HUD runtime lightweight and avoid mixing two UIs.
        * rv-app is a full learning studio; HUD is a minimal overlay.
  ============================================================
-->

<!--
  ============================================================
  HUD (renderer/) ‚Äì PROJECT MAP
  ------------------------------------------------------------
  Role:
    - This is the web-based heads-up display (HUD) shown inside Electron.
    - Contains video controls, playlist manager, step counter,
      telemetry status, Google Fit integration, and passport export.

  Structure:
    index.html       ‚Üí Loads HUD layout + scripts
    renderer.js      ‚Üí Main HUD logic (video playback, Fit, playlists)
    passport.js      ‚Üí Passport export/logic
    style.css        ‚Üí Static HUD styling (no bundler)
    package.json     ‚Üí HUD-specific metadata (no build step)

  Notes:
    - No bundler, no Vite/Webpack. Everything is served as static files.
    - HUD is distinct from rv-app (learning studio).
    - Renderer receives data but does not compile, bundle, or transform it.
  ============================================================
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Ballpoint ink SVG filter -->
    <svg width="0" height="0" style="position: absolute; pointer-events: none;" aria-hidden="true">
      <defs>
        <filter id="ballpoint-ink" x="-5%" y="-5%" width="110%" height="110%" color-interpolation-filters="sRGB">
          <feTurbulence type="fractalNoise" baseFrequency="0.25 0.35" numOctaves="2" seed="11" result="paperGrain" />
          <feComponentTransfer in="paperGrain" result="inkFlow">
            <feFuncR type="table" tableValues="0.48 0.52 0.56" />
            <feFuncG type="table" tableValues="0.48 0.52 0.56" />
            <feFuncB type="table" tableValues="0.48 0.52 0.56" />
          </feComponentTransfer>
          <feDisplacementMap in="SourceGraphic" in2="inkFlow" scale="0.65" xChannelSelector="R" yChannelSelector="G" result="waveredInk" />
          <feGaussianBlur in="waveredInk" stdDeviation="0.35" result="featheredInk" />
          <feComponentTransfer in="featheredInk" result="inked">
            <feFuncR type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncG type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncB type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncA type="table" tableValues="0 0.16 0.42 0.78 1" />
          </feComponentTransfer>
          <feComposite in="inked" in2="inkFlow" operator="arithmetic" k1="0" k2="1" k3="0.08" k4="0" result="finalInk" />
        </filter>
      </defs>
    </svg>
    <title>RunnyVision HUD</title>
    <link rel="stylesheet" href="style.css?v=13" />
  </head>
  <body data-google-client-id="your-google-client-id.apps.googleusercontent.com">
    <!-- Import ballpoint ink filter for notebook aesthetic on labels -->
    <svg width="0" height="0" style="position: absolute; pointer-events: none;" aria-hidden="true">
      <defs>
        <filter id="ballpoint-ink" x="-5%" y="-5%" width="110%" height="110%" color-interpolation-filters="sRGB">
          <feTurbulence type="fractalNoise" baseFrequency="0.25 0.35" numOctaves="2" seed="11" result="paperGrain" />
          <feComponentTransfer in="paperGrain" result="inkFlow">
            <feFuncR type="table" tableValues="0.48 0.52 0.56" />
            <feFuncG type="table" tableValues="0.48 0.52 0.56" />
            <feFuncB type="table" tableValues="0.48 0.52 0.56" />
          </feComponentTransfer>
          <feDisplacementMap in="SourceGraphic" in2="inkFlow" scale="0.65" xChannelSelector="R" yChannelSelector="G" result="waveredInk" />
          <feGaussianBlur in="waveredInk" stdDeviation="0.35" result="featheredInk" />
          <feComponentTransfer in="featheredInk" result="inked">
            <feFuncR type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncG type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncB type="gamma" amplitude="0.98" exponent="0.9" offset="0" />
            <feFuncA type="table" tableValues="0 0.16 0.42 0.78 1" />
          </feComponentTransfer>
          <feComposite in="inked" in2="inkFlow" operator="arithmetic" k1="0" k2="1" k3="0.08" k4="0" result="finalInk" />
        </filter>
      </defs>
    </svg>

    <!-- RunnyVision player with ballpoint ink frame -->
    <div class="video-wrapper" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; padding: 20px; box-sizing: border-box;">
      <video id="videoA" class="video-layer visible" playsinline muted autoplay style="position: absolute; top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px); object-fit: cover; transition: opacity 1.5s; border-radius: 12px; opacity: 1;"></video>
      <video id="videoB" class="video-layer" playsinline muted style="position: absolute; top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px); object-fit: cover; transition: opacity 1.5s; border-radius: 12px; opacity: 0;"></video>
    </div>
    <!-- Hidden controls for RunnyVision player -->
    <select id="duration" style="display: none;">
      <option value="10" selected>10 minutes</option>
    </select>
    <button id="start" style="display: none;">Start Run</button>
    <div id="status" style="display: none;"></div>
    <canvas id="fx-canvas" width="1920" height="1080" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1; mix-blend-mode: screen; opacity: 0;"></canvas>

    <div id="hud">
      <div id="music-controller" class="row" style="margin-bottom: 12px; padding: 16px; border-radius: 12px; background: rgba(15, 23, 42, 0.65);">
        <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e63946; filter: url(#ballpoint-ink);">üéµ Music Control</h3>
        <input type="file" id="music-file-input" accept=".mp3,.wav,.ogg,.m4a" style="display: block; margin-bottom: 10px; padding: 6px 10px; border-radius: 6px; background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #e2e8f0; cursor: pointer; font-size: 0.9rem;" />
        <div style="margin-bottom: 10px;">
          <button id="music-play" type="button" class="frame-rect" disabled style="margin-right: 6px;">Play</button>
          <button id="music-pause" type="button" class="frame-rect" disabled style="margin-right: 6px;">Pause</button>
          <button id="music-stop" type="button" class="frame-rect" disabled>Stop</button>
        </div>
        <div class="music-info" style="font-size: 0.85em; opacity: 0.8; filter: url(#ballpoint-ink);">
          <div id="music-file-name">No file loaded</div>
          <div id="music-bpm">BPM: --</div>
          <div id="music-status">Status: Idle</div>
        </div>
      </div>
      <div class="row" id="google-auth-row">
        <button id="google-sign-in" type="button" class="frame-rect">Sign in with Google</button>
        <span id="google-auth-status" style="margin-left: 8px; opacity: 0.7;"></span>
      </div>
      <div class="row" id="video-playlist-row">
        <strong style="margin-right: 6px; filter: url(#ballpoint-ink);">Playlist:</strong>
        <select id="video-playlists" disabled style="min-width: 220px;"></select>
        <button id="video-load" type="button" class="frame-rect" disabled>Load</button>
        <button id="video-prev" type="button" class="frame-rect" disabled>‚èÆÔ∏è</button>
        <button id="video-next" type="button" class="frame-rect" disabled>‚è≠Ô∏è</button>
        <button id="video-shuffle" type="button" class="frame-rect" disabled>üîÄ</button>
        <button id="video-refresh" type="button" class="frame-rect" disabled title="Refresh playlists">‚Üª</button>
        <label style="margin-left: 8px; filter: url(#ballpoint-ink);">Volume</label>
        <input id="video-volume" type="range" min="0" max="100" step="1" value="50" disabled />
        <span id="playlist-status" style="margin-left: 10px; font-size: 0.85em; opacity: 0.7;"></span>
      </div>
      <div class="row">
        <strong style="filter: url(#ballpoint-ink);">Tag:</strong>
        <button data-tag="Dreamcore" class="frame-rect">Dreamcore</button>
        <button data-tag="Ambient" class="frame-rect">Ambient</button>
        <button data-tag="Urban" class="frame-rect">Urban</button>
        <span id="current-tag" style="margin-left:12px; opacity: 0.6;"></span>
      </div>
      <div class="row" id="fit-status-row" style="font-size: 0.85em; opacity: 0.75;">
        <span id="fit-status">Google Fit inactive</span>
        <span style="margin-left: auto;">Session: <span id="session-time">0:00</span></span>
      </div>
      <!-- Add to HUD for manual export button -->
      <div class="row">
        <button id="open-hallucination-controls" type="button" class="frame-rect">Hallucination Controls</button>
        <a href="hand-drawn-demo.html" target="_blank" style="text-decoration: none;">
          <button type="button" class="frame-rect">Hand-Drawn Demo</button>
        </a>
        <button id="hud-hide-button" type="button" class="frame-rect" style="margin-left: auto;">Hide HUD</button>
      </div>
    </div>

    <button
      id="hud-floating-toggle"
      class="frame-circle"
      type="button"
      title="Show HUD"
      hidden
      aria-controls="hud"
      aria-expanded="false"
    >HUD</button>

    <div id="video-player-container">
      <video id="v1" class="atom-video active" muted playsinline aria-label="Video layer 1"></video>
      <video id="v2" class="atom-video" muted playsinline aria-label="Video layer 2"></video>
      <div id="video-controls" aria-label="Video controls">
        <button id="video-play" type="button" class="frame-rect">Play</button>
        <button id="video-pause" type="button" class="frame-rect">Pause</button>
        <button id="video-stop" type="button" class="frame-rect">Stop</button>
      </div>
    </div>

    <div id="fx-overlay" aria-hidden="true"></div>

    <script type="module">
      // Music controller integration - MUST RUN BEFORE button conversion
      let audioContext = null;
      let audioBuffer = null;
      let sourceNode = null;
      let analyserNode = null;
      let isPlaying = false;
      let startTime = 0;
      let pauseTime = 0;

      const fileInput = document.getElementById('music-file-input');
      const playBtn = document.getElementById('music-play');
      const pauseBtn = document.getElementById('music-pause');
      const stopBtn = document.getElementById('music-stop');
      const fileNameEl = document.getElementById('music-file-name');
      const bpmEl = document.getElementById('music-bpm');
      const statusEl = document.getElementById('music-status');

      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          analyserNode = audioContext.createAnalyser();
          analyserNode.fftSize = 2048;
          analyserNode.connect(audioContext.destination);
        }
      }

      function playMusic() {
        if (!audioBuffer || !audioContext) return;
        
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        if (sourceNode) {
          sourceNode.stop();
        }

        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = audioBuffer;
        sourceNode.connect(analyserNode);

        const offset = pauseTime;
        sourceNode.start(0, offset);
        startTime = audioContext.currentTime - offset;
        isPlaying = true;
        statusEl.textContent = 'Status: Playing';

        sourceNode.onended = () => {
          if (isPlaying) {
            isPlaying = false;
            pauseTime = 0;
            statusEl.textContent = 'Status: Ended';
          }
        };
      }

      function pauseMusic() {
        if (!sourceNode || !isPlaying) return;
        
        sourceNode.stop();
        pauseTime = audioContext.currentTime - startTime;
        isPlaying = false;
        statusEl.textContent = 'Status: Paused';
      }

      function stopMusic() {
        if (sourceNode) {
          sourceNode.stop();
        }
        pauseTime = 0;
        isPlaying = false;
        statusEl.textContent = 'Status: Stopped';
      }

      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        initAudioContext();
        fileNameEl.textContent = `Loading: ${file.name}`;
        statusEl.textContent = 'Status: Loading...';

        try {
          const arrayBuffer = await file.arrayBuffer();
          audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
          
          fileNameEl.textContent = `Loaded: ${file.name}`;
          statusEl.textContent = 'Status: Ready';
          playBtn.disabled = false;
          pauseBtn.disabled = false;
          stopBtn.disabled = false;

          bpmEl.textContent = 'BPM: ~120';

          if (typeof window.enableMusicDrivenMode === 'function') {
            window.enableMusicDrivenMode(true);
          }
        } catch (err) {
          console.error('Error loading audio:', err);
          fileNameEl.textContent = 'Error loading file';
          statusEl.textContent = 'Status: Error';
        }
      });

      // Attach handlers - these will work even after button conversion
      playBtn.addEventListener('click', playMusic);
      pauseBtn.addEventListener('click', pauseMusic);
      stopBtn.addEventListener('click', stopMusic);

      // Make handlers available globally for re-attachment after button conversion
      window.musicHandlers = { playMusic, pauseMusic, stopMusic };
    </script>

    <script type="module">
      // Convert HUD buttons to hand-drawn SVG - runs immediately, before other scripts
      import { createHandDrawnButton } from './hand-drawn-rect.js';
      
      // Replace buttons synchronously as soon as this script loads (runs inline during parse)
      const buttons = document.querySelectorAll('#hud button, #video-controls button');
      buttons.forEach(btn => {
        const text = btn.textContent.trim();
        const seed = text.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        
        const svg = createHandDrawnButton(text, { 
          width: 110, 
          height: 28,
          seed: seed,
        });
        
        // Copy attributes to SVG but NOT className (to avoid CSS background conflicts)
        if (btn.id) svg.id = btn.id;
        if (btn.type) svg.setAttribute('data-type', btn.type);
        svg.classList.add('hand-drawn-button'); // Mark as hand-drawn
        if (btn.disabled) {
          svg.setAttribute('data-disabled', 'true');
          svg.style.opacity = '0.5';
          svg.style.pointerEvents = 'none';
        }
        if (btn.title) svg.setAttribute('title', btn.title);
        Array.from(btn.attributes).forEach(attr => {
          if (attr.name.startsWith('data-') || attr.name.startsWith('aria-')) {
            svg.setAttribute(attr.name, attr.value);
          }
        });
        
        svg.style.display = 'inline-block';
        svg.style.verticalAlign = 'middle';
        
        btn.parentNode.replaceChild(svg, btn);
      });
    </script>

    <script type="module">
      import { downloadLog } from './sessionLogger.js';
      window.downloadSessionLog = downloadLog;
    </script>
    
    <script type="module">
      // RunnyVision Player with B2 authentication
      import { RunnyVisionPlayer } from '/runnyvision/demo/player-auth.js';
      
      const videoA = document.getElementById('videoA');
      const videoB = document.getElementById('videoB');
      const statusDiv = document.getElementById('status');
      const durationSelect = document.getElementById('duration');
      const startBtn = document.getElementById('start');
      
      const player = new RunnyVisionPlayer(videoA, videoB, {
        apiBase: 'http://localhost:4000',
        onStatusChange: (msg) => {
          if (statusDiv) statusDiv.textContent = msg;
          console.log('[RunnyVision]', msg);
        }
      });
      
      // Auto-start on load
      window.addEventListener('DOMContentLoaded', () => {
        console.log('[RunnyVision] Starting player...');
        const duration = durationSelect ? parseInt(durationSelect.value) : 10;
        player.startRun(duration);
        
        // Re-attach music button handlers after button conversion
        setTimeout(() => {
          const musicPlay = document.getElementById('music-play');
          const musicPause = document.getElementById('music-pause');
          const musicStop = document.getElementById('music-stop');

          if (window.musicHandlers) {
            if (musicPlay) {
              musicPlay.addEventListener('click', window.musicHandlers.playMusic);
              console.log('[Music] Play handler attached');
            }
            if (musicPause) musicPause.addEventListener('click', window.musicHandlers.pauseMusic);
            if (musicStop) musicStop.addEventListener('click', window.musicHandlers.stopMusic);
          }
        }, 100);
      });
      
      // Manual start button
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          const duration = durationSelect ? parseInt(durationSelect.value) : 10;
          player.startRun(duration);
        });
      }
    </script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="passport.js?v=7" type="module"></script>
    <script src="renderer.js?v=15" type="module"></script>
  </body>
</html>

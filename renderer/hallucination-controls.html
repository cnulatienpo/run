<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hallucination Controls</title>
  <link rel="stylesheet" href="/assets/frame-theme.css">
  <style>
    :root {
      color-scheme: dark;
      --bg: #050a0f;
      --panel: #0f1d2a;
      --accent: #0ff2c3;
      --text: #f2f8ff;
      --muted: #6f8096;
      font-family: var(--rv-font);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      font-family: var(--rv-font);
    }

    #controls-container {
      max-width: 800px;
      margin: 0 auto;
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }

    h1 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 2rem;
    }

    section {
      background: none !important;
      border: none !important;
      padding: 0 !important;
      margin-bottom: 2rem;
      border-radius: 0 !important;
      background-image: none !important;
    }

    h3 {
      margin-top: 0;
      color: var(--accent);
    }

    button {
      background-color: var(--accent);
      background-image: none !important;
      color: var(--bg);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.8;
    }

    input[type="range"] {
      width: 100%;
      margin: 0.5rem 0;
      background-image: none !important;
    }

    input[type="checkbox"] {
      margin-right: 0.5rem;
      background-image: none !important;
    }

    input[type="number"],
    input[type="text"],
    input[type="file"] {
      background-image: none !important;
    }

    label {
      display: flex;
      align-items: center;
      margin: 0.5rem 0;
      cursor: pointer;
    }

    .slider-group {
      margin: 1rem 0;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .pack-card {
      border: none !important;
      border-radius: 0 !important;
      padding: 0.5rem 0 !important;
      margin-bottom: 0.75rem;
      background: none !important;
      background-image: none !important;
    }

    details {
      margin-top: 0.75rem;
      background: none !important;
      border: none !important;
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: none !important;
      border: none !important;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .mood-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
      background: none !important;
      border: none !important;
    }

    * {
      background-image: none !important;
    }
  </style>
</head>
<body>
  <div id="controls-container">
    <h1>Hallucination Controls</h1>
    <p class="subtitle">Fine-tune visual effects and psychedelic overlays in real-time</p>
    <div id="hallucination-controls-mount"></div>
  </div>

  <script type="module">
    import { 
      configureEffectPacks,
      setEffectInterval,
      setRareChance,
      setIntensityMultiplier,
      updateBPM,
      recordTag,
      getRecentTags,
      clearRecentTags,
      exportSessionLog,
      replaySession
    } from './hallucinationEngine.js';

    const PACKS = ['default', 'fog', 'dreamcore'];
    const MOODS = ['ambient', 'rare', 'glide', 'dreamcore'];
    const STORAGE_KEY = 'rv.hallucination.settings';

    const defaultMoods = () => ({
      ambient: true,
      rare: true,
      glide: true,
      dreamcore: true,
    });

    function loadSettings() {
      const defaults = {
        selectedPacks: ['default'],
        packMoods: {
          default: defaultMoods(),
          fog: defaultMoods(),
          dreamcore: defaultMoods(),
        },
        effectInterval: 4000,
        rareChance: 0.02,
        intensityMultiplier: 1,
        bpm: 100,
        bpmOverride: false,
        stepRate: 0,
        replaySpeed: 1,
      };

      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaults;
        const parsed = JSON.parse(raw);
        return {
          ...defaults,
          ...parsed,
          packMoods: { ...defaults.packMoods, ...(parsed.packMoods || {}) },
        };
      } catch (error) {
        console.warn('Failed to load settings', error);
        return defaults;
      }
    }

    function persistSettings(settings) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      } catch (error) {
        console.warn('Failed to persist settings', error);
      }
    }

    function applySettingsToEngine(settings) {
      configureEffectPacks({
        selectedPacks: settings.selectedPacks,
        moodFilters: settings.packMoods,
      });
      setEffectInterval(settings.effectInterval);
      setRareChance(settings.rareChance);
      setIntensityMultiplier(settings.intensityMultiplier);
      if (settings.bpmOverride) {
        updateBPM(settings.bpm);
      }
    }

    let settings = loadSettings();
    applySettingsToEngine(settings);

    function updateSettings(partial) {
      settings = { ...settings, ...partial };
      persistSettings(settings);
      applySettingsToEngine(settings);
      render();
    }

    function createSlider(label, min, max, step, value, onChange, asPercent = false) {
      const group = document.createElement('div');
      group.className = 'slider-group';

      const labelDiv = document.createElement('div');
      labelDiv.className = 'slider-label';
      
      const labelText = document.createElement('span');
      labelText.textContent = label;
      
      const valueText = document.createElement('span');
      valueText.textContent = asPercent ? `${Math.round(value * 100)}%` : value.toFixed(2).replace(/\.00$/, '');

      labelDiv.append(labelText, valueText);

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = String(min);
      slider.max = String(max);
      slider.step = String(step);
      slider.value = String(value);

      slider.addEventListener('input', () => {
        const newValue = Number(slider.value);
        valueText.textContent = asPercent ? `${Math.round(newValue * 100)}%` : newValue.toFixed(2).replace(/\.00$/, '');
        onChange(newValue);
      });

      group.append(labelDiv, slider);
      return group;
    }

    function refreshTags(container) {
      const tags = getRecentTags(8);
      container.textContent = tags.length ? `Recent: ${tags.join(', ')}` : 'No tags recorded yet';
    }

    function render() {
      const container = document.getElementById('hallucination-controls-mount');
      container.innerHTML = '';

      // Effect Packs Section
      const packsSection = document.createElement('section');
      packsSection.innerHTML = '<h3>Effect Packs</h3>';
      
      PACKS.forEach(packName => {
        const card = document.createElement('div');
        card.className = 'pack-card';

        const packLabel = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = settings.selectedPacks.includes(packName);
        
        checkbox.addEventListener('change', () => {
          const next = new Set(settings.selectedPacks);
          if (checkbox.checked) {
            next.add(packName);
          } else {
            next.delete(packName);
          }
          if (!next.size) next.add('default');
          updateSettings({ selectedPacks: Array.from(next) });
        });

        const title = document.createElement('strong');
        title.textContent = packName.charAt(0).toUpperCase() + packName.slice(1);
        packLabel.append(checkbox, title);
        card.append(packLabel);

        // Moods
        const details = document.createElement('details');
        details.open = checkbox.checked;
        const summary = document.createElement('summary');
        summary.textContent = 'Moods';
        details.append(summary);

        const moodGrid = document.createElement('div');
        moodGrid.className = 'mood-grid';
        
        const packMoods = settings.packMoods[packName] || defaultMoods();
        
        MOODS.forEach(mood => {
          const moodLabel = document.createElement('label');
          const moodCheckbox = document.createElement('input');
          moodCheckbox.type = 'checkbox';
          moodCheckbox.checked = packMoods[mood];
          
          moodCheckbox.addEventListener('change', () => {
            const updated = {
              ...settings.packMoods,
              [packName]: { ...packMoods, [mood]: moodCheckbox.checked },
            };
            updateSettings({ packMoods: updated });
          });
          
          moodLabel.append(moodCheckbox, document.createTextNode(mood.charAt(0).toUpperCase() + mood.slice(1)));
          moodGrid.appendChild(moodLabel);
        });

        details.append(moodGrid);
        card.append(details);
        packsSection.append(card);
      });

      container.append(packsSection);

      // Sliders Section
      const slidersSection = document.createElement('section');
      slidersSection.innerHTML = '<h3>Spawn & Intensity</h3>';
      slidersSection.append(
        createSlider('Spawn Interval (ms)', 800, 8000, 200, settings.effectInterval, 
          value => updateSettings({ effectInterval: value })),
        createSlider('Rare Chance', 0, 0.25, 0.005, settings.rareChance, 
          value => updateSettings({ rareChance: value }), true),
        createSlider('Intensity Multiplier', 0.5, 2, 0.1, settings.intensityMultiplier, 
          value => updateSettings({ intensityMultiplier: value }))
      );
      container.append(slidersSection);

      // BPM Section
      const bpmSection = document.createElement('section');
      bpmSection.innerHTML = '<h3>Rhythm</h3>';
      
      const bpmRow = document.createElement('div');
      bpmRow.style.display = 'flex';
      bpmRow.style.alignItems = 'center';
      bpmRow.style.gap = '12px';
      bpmRow.style.marginBottom = '12px';
      
      const bpmLabel = document.createElement('span');
      bpmLabel.textContent = 'BPM';
      
      const bpmInput = document.createElement('input');
      bpmInput.type = 'number';
      bpmInput.min = '60';
      bpmInput.max = '190';
      bpmInput.value = String(settings.bpm);
      bpmInput.style.padding = '0.5rem';
      bpmInput.style.borderRadius = '4px';
      bpmInput.style.border = '1px solid rgba(255,255,255,0.2)';
      bpmInput.style.backgroundColor = 'rgba(0,0,0,0.3)';
      bpmInput.style.color = 'inherit';
      bpmInput.style.width = '100px';
      
      bpmInput.addEventListener('input', () => {
        const bpm = Number(bpmInput.value) || 100;
        updateSettings({ bpm });
        if (settings.bpmOverride) {
          updateBPM(bpm);
        }
      });

      const overrideLabel = document.createElement('label');
      overrideLabel.style.display = 'flex';
      overrideLabel.style.alignItems = 'center';
      overrideLabel.style.gap = '6px';
      
      const overrideCheckbox = document.createElement('input');
      overrideCheckbox.type = 'checkbox';
      overrideCheckbox.checked = settings.bpmOverride;
      overrideCheckbox.addEventListener('change', () => {
        updateSettings({ bpmOverride: overrideCheckbox.checked });
      });
      
      overrideLabel.append(overrideCheckbox, document.createTextNode('Override auto BPM detection'));
      bpmRow.append(bpmLabel, bpmInput, overrideLabel);
      bpmSection.append(bpmRow);
      container.append(bpmSection);

      // Session Controls Section
      const sessionSection = document.createElement('section');
      sessionSection.innerHTML = '<h3>Session</h3>';
      
      const exportBtn = document.createElement('button');
      exportBtn.textContent = 'Export Session Log';
      exportBtn.style.marginBottom = '12px';
      exportBtn.addEventListener('click', () => {
        exportSessionLog();
      });
      
      const importLabel = document.createElement('label');
      importLabel.style.display = 'flex';
      importLabel.style.flexDirection = 'column';
      importLabel.style.gap = '6px';
      importLabel.style.marginBottom = '12px';
      importLabel.textContent = 'Replay log (.json)';
      
      const importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.accept = '.json,application/json';
      importInput.addEventListener('change', async () => {
        const file = importInput.files?.[0];
        if (!file) return;
        try {
          const content = await file.text();
          const data = JSON.parse(content);
          replaySession(data, settings.replaySpeed || 1);
        } catch (error) {
          console.warn('Failed to replay log', error);
        }
      });
      importLabel.append(importInput);
      
      const replaySpeedLabel = document.createElement('label');
      replaySpeedLabel.style.display = 'flex';
      replaySpeedLabel.style.flexDirection = 'column';
      replaySpeedLabel.style.gap = '6px';
      replaySpeedLabel.style.marginBottom = '12px';
      replaySpeedLabel.textContent = 'Replay speed';
      
      const replaySpeed = document.createElement('input');
      replaySpeed.type = 'number';
      replaySpeed.step = '0.25';
      replaySpeed.min = '0.25';
      replaySpeed.value = String(settings.replaySpeed ?? 1);
      replaySpeed.style.padding = '0.5rem';
      replaySpeed.style.borderRadius = '4px';
      replaySpeed.style.border = '1px solid rgba(255,255,255,0.2)';
      replaySpeed.style.backgroundColor = 'rgba(0,0,0,0.3)';
      replaySpeed.style.color = 'inherit';
      replaySpeed.style.width = '100px';
      replaySpeed.addEventListener('input', () => {
        updateSettings({ replaySpeed: Number(replaySpeed.value) || 1 });
      });
      replaySpeedLabel.append(replaySpeed);
      
      const stepRateRow = document.createElement('div');
      stepRateRow.style.display = 'flex';
      stepRateRow.style.alignItems = 'center';
      stepRateRow.style.gap = '8px';
      stepRateRow.style.marginBottom = '12px';
      
      const stepRateLabel = document.createElement('span');
      stepRateLabel.textContent = 'Step rate (for preview)';
      
      const stepRateInput = document.createElement('input');
      stepRateInput.type = 'range';
      stepRateInput.min = '0';
      stepRateInput.max = '180';
      stepRateInput.step = '1';
      stepRateInput.value = String(settings.stepRate ?? 0);
      stepRateInput.style.flex = '1';
      
      const stepRateValue = document.createElement('span');
      stepRateValue.textContent = `${settings.stepRate ?? 0} spm`;
      stepRateValue.style.minWidth = '60px';
      
      stepRateInput.addEventListener('input', () => {
        const value = Number(stepRateInput.value) || 0;
        stepRateValue.textContent = `${value} spm`;
        updateSettings({ stepRate: value });
      });
      
      stepRateRow.append(stepRateLabel, stepRateInput, stepRateValue);
      
      sessionSection.append(exportBtn, importLabel, replaySpeedLabel, stepRateRow);
      container.append(sessionSection);

      // Tags Section
      const tagsSection = document.createElement('section');
      tagsSection.innerHTML = '<h3>Tags</h3>';
      
      const recentTags = document.createElement('div');
      recentTags.style.marginBottom = '12px';
      refreshTags(recentTags);
      
      const addRow = document.createElement('div');
      addRow.style.display = 'flex';
      addRow.style.gap = '8px';
      
      const tagInput = document.createElement('input');
      tagInput.type = 'text';
      tagInput.placeholder = 'Add tag';
      tagInput.style.flex = '1';
      tagInput.style.padding = '0.5rem';
      tagInput.style.borderRadius = '4px';
      tagInput.style.border = '1px solid rgba(255,255,255,0.2)';
      tagInput.style.backgroundColor = 'rgba(0,0,0,0.3)';
      tagInput.style.color = 'inherit';
      
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add';
      addBtn.addEventListener('click', () => {
        if (!tagInput.value.trim()) return;
        recordTag(tagInput.value.trim());
        tagInput.value = '';
        refreshTags(recentTags);
      });
      
      const clearBtn = document.createElement('button');
      clearBtn.textContent = 'Clear';
      clearBtn.addEventListener('click', () => {
        clearRecentTags();
        refreshTags(recentTags);
      });
      
      addRow.append(tagInput, addBtn, clearBtn);
      tagsSection.append(recentTags, addRow);
      container.append(tagsSection);

      // Randomize Button
      const randomizeBtn = document.createElement('button');
      randomizeBtn.textContent = 'Randomize Everything';
      randomizeBtn.style.width = '100%';
      randomizeBtn.style.marginTop = '1rem';
      randomizeBtn.addEventListener('click', () => {
        const randomPackSelection = PACKS.filter(() => Math.random() > 0.4);
        const selectedPacks = randomPackSelection.length ? randomPackSelection : ['default'];
        
        const packMoods = { ...settings.packMoods };
        selectedPacks.forEach(pack => {
          const moods = { ...packMoods[pack] };
          MOODS.forEach(mood => {
            moods[mood] = Math.random() > 0.2;
          });
          packMoods[pack] = moods;
        });
        
        updateSettings({
          selectedPacks,
          packMoods,
          effectInterval: Math.round(800 + Math.random() * 6000),
          rareChance: Math.random() * 0.25,
          intensityMultiplier: Number((0.5 + Math.random() * 1.5).toFixed(2)),
          bpm: 80 + Math.round(Math.random() * 80),
          bpmOverride: Math.random() > 0.5,
          stepRate: Math.round(Math.random() * 160),
          replaySpeed: Number((0.5 + Math.random() * 1.5).toFixed(2)),
        });
      });
      
      container.append(randomizeBtn);
    }

    render();
  </script>
</body>
</html>
